<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset=utf-8>
    <title>Three.js Blender Geometry Example</title>
    <style>
        body { margin: 0; overflow: hidden }
        canvas { width: 100%; height: 100% }
    </style>
    <link rel="stylesheet" href="css/common.css">
</head>

<body>

<script async src="./dist/es-module-shims.js"></script>
<script type="importmap">
    {
        "imports": {
            "three": "./js-r179/build/three.module.js",
            "lil-gui": "./js-r179/examples/jsm/libs/lil-gui.module.min.js",
            "tween": "./js-r179/examples/jsm/libs/tween.module.js",
            "trackballcontrols": "./js-r179/examples/jsm/controls/TrackballControls.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import * as TWEEN from 'tween';
    import { TrackballControls } from 'trackballcontrols';
    import { buildWorld } from './js/buildWorld.js';
    import { buildLight } from './js/buildLight.js';
    import { initHelpOverlay } from './js/helpOverlay.js';
    import { initKeyboard } from './js/keyboard.js';
    import { resetCamera } from './js/keyboard.js';
    import { initEvents } from './js/events.js';
    import { addControlGui } from './js/gui.js';
    import { applyGuiState } from './js/gui.js';
    import { animateFlagWind } from './js/animation.js';

    // Globális változók
    let WIDTH, HEIGHT, aspectRatio;
    let scene, camera;
    let renderer;
    let trackballcontrols;

    let meshController = function () {
        this.showAxisHelper = false;
        this.showSpotlightHelper = false;
        this.isDayLight = true;
        this.daylightIntensitiy = 900;
        this.windVelocity = 3;

        this.showLeftLamp = true;
        this.showRightLamp = true;
        this.showWell = true;
        this.showFlag = true;
        this.showFence = true;
        this.showRoad = true;
        this.showBillboard = true;
        this.showWelcomeText = true;

        this.resetCamera = function() {
            resetCamera(scene, camera);
        };
    };

    init();

    async function init() {
        // Böngésző ablakméret lekérése és méretarány számítása
        HEIGHT = window.innerHeight;
        WIDTH = window.innerWidth;
        aspectRatio = WIDTH / HEIGHT;

        // Színtér létrehozása
        scene = new THREE.Scene();

        //GUI kontrolok létrehozása
        meshController = new meshController();
        let gui = addControlGui(scene, meshController);

        // Renderer létrehozása
        buildRender();

        //Kamera létrehozása
        buildCamera();

        //Kamera ctrl beállítások
        buildCameraControls();

        //Objektumok létrehozása
        await buildWorld(scene, meshController);

        //Fények létrehozáa
        buildLight(scene, meshController);

        //Event kezelés
        initEvents(scene, gui);

        // Az ablak átméretezése esetén visszahívható függvény megadása
        window.addEventListener( 'resize', handleWindowResize, false );

        //Megjelenítés és állapot beállítása
        applyGuiState(scene, meshController);

        initHelpOverlay();
        initKeyboard(scene, camera, meshController);

        render();
        animate();
    }

    function handleWindowResize() {
        // Az ablak átméretezése esetén a kamera vetítési paraméterek újraszámolása
        HEIGHT = window.innerHeight;
        WIDTH = window.innerWidth;
        renderer.setSize( WIDTH, HEIGHT );
        camera.aspect = WIDTH / HEIGHT;
        camera.updateProjectionMatrix();

        render();
    }

    function animate() {
        requestAnimationFrame(animate);

        TWEEN.update();
        trackballcontrols.update();
        animateFlagWind(scene, meshController);

        render();
    }

    function render() {
        renderer.render(scene, camera);
    }

    function buildRender() {
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setSize( WIDTH, HEIGHT );
        renderer.setClearColor( 0x202020 );
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild( renderer.domElement );
    }

    function buildCamera() {
        camera = new THREE.PerspectiveCamera( 75, aspectRatio, 0.1, 1000 );
        resetCamera(scene, camera);
    }

    function buildCameraControls() {
        trackballcontrols = new TrackballControls( camera, renderer.domElement );
        trackballcontrols.rotateSpeed = 3.0;
        trackballcontrols.panSpeed = 0.5;
    }

</script>

<div id="hud">
    <div><strong>Név:</strong> Németh Balázs</div>
    <div><strong>NEPTUN:</strong> MC4JL5</div>
    <div><strong>Szak:</strong> Programtervező informatikus Bsc.</div>
    <div><strong>Tanév:</strong> 2025/2026 ősz</div>
</div>

</body>
</html>
